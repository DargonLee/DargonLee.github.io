<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>七里田间的守望者</title>
<link rel="shortcut icon" href="https://dargonlee.github.io/favicon.ico">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css" rel="stylesheet">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"> -->
<link rel="stylesheet" href="https://dargonlee.github.io/media/css/tailwind.css">
<link rel="stylesheet" href="https://dargonlee.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="七里田间的守望者 - Atom Feed" href="https://dargonlee.github.io/atom.xml">

    

  <meta name="description" content="我不在乎是悲伤的离别还是不痛快的离别，只要是离开一个地方，我总希望离开的时候自己心中有数。" />
</head>
<body>
  <div class="antialiased flex flex-col min-h-screen" id="app">

    <div class="nav py-3 md:py-8 fixed w-full z-10 bg-gray-50 dark:bg-gray-700 transition-all duration-300" :class="{ 'scroll': scrolled }">
  <div class="flex justify-end px-4">
    <div class="w-8 h-8 flex justify-center items-center rounded-full md:hidden" @click="showMenu = !showMenu">
      <i class="ri-close-line" v-show="showMenu"></i>
      <i class="ri-menu-3-line" v-show="!showMenu"></i>
    </div>
  </div>
  <nav class="max-w-4xl w-full mx-auto text-center flex flex-col md:flex-row justify-center md:block" :class="`${ showMenu ? 'block' : 'hidden' }`">
    
      <a href="/" target="" class="py-2 md:py-1 px-4 mx-4 inline-flex transition font-semibold rounded dark:hover:bg-gray-600 hover:bg-gray-200">
        首页
      </a>
    
      <a href="/archives" target="" class="py-2 md:py-1 px-4 mx-4 inline-flex transition font-semibold rounded dark:hover:bg-gray-600 hover:bg-gray-200">
        归档
      </a>
    
      <a href="/tags" target="" class="py-2 md:py-1 px-4 mx-4 inline-flex transition font-semibold rounded dark:hover:bg-gray-600 hover:bg-gray-200">
        标签
      </a>
    
      <a href="/post/about" target="" class="py-2 md:py-1 px-4 mx-4 inline-flex transition font-semibold rounded dark:hover:bg-gray-600 hover:bg-gray-200">
        关于
      </a>
    
    <a href="https://dargonlee.github.io/atom.xml" target="_blank" class="py-2 md:py-1 px-4 mx-4 inline-flex transition font-semibold rounded dark:hover:bg-gray-600 hover:bg-gray-200">
      RSS
    </a>
  </nav>
</div>

    <div class="max-w-4xl w-full mx-auto pt-32">
      <h1 class="text-2xl font-bold pb-8 flex justify-center items-center">
        <i class="ri-hashtag"></i>
        iOS逆向
      </h1>
      <div class="shadow-box bg-white dark:bg-gray-600 border-gray-300 rounded-none md:rounded-lg -mx-1 md:mx-0 md:px-0">
        
  <div class="p-8 border-b border-gray-200 dark:border-gray-700 flex relative overflow-hidden flex-col md:flex-row animated fadeIn">
    
    <div class="flex-1 order-2 md:order-1">
      <h2 class="text-2xl font-semibold mb-4">
        <a href="https://dargonlee.github.io/post/ssh-lian-jie-shou-ji-de-fang-shi/" class="text-gray-700 dark:text-gray-200 border-b-2 border-dotted border-gray-200 dark:border-gray-400 dark:hover:border-gray-200 hover:border-gray-600 transition-all duration-100">
          ssh连接手机的方式
        </a>
      </h2>
      <div class="mb-4 text-xs text-gray-500">2020-07-25</div>
      <div class="mb-4 text-gray-500 dark:text-gray-300">
        <h4 id="通过usb连接iphone">通过USB连接iPhone</h4>
<ul>
<li>用<code>iproxy</code> 转发端口</li>
</ul>
<pre><code>iproxy 2222 22 进行端口转发
</code></pre>
<p>想要支持多个ssh连接的话 需要添加参数 -t<br>
如果加<code>-t</code> 不行的 请使用<code>usbmuxd</code>的1.0.8版本</p>
<p>如果是1.0.8版本的需要执行下面的命令进行端口转发</p>
<pre><code>python tcprelay.py -t 22:2222
</code></pre>
<p>这里的<code>-t</code>就是支持多个ssh连接的参数</p>
<p>然后连接好USB进行登录手机</p>
<pre><code>ssh -p 2222 root@127.0.0.1
或者
ssh -p 2222 root@localhost
</code></pre>
<blockquote>
<p>上面代码意义在于将iPhone的22端口（ssh端口）映射到Mac本地的2222端口</p>
</blockquote>
<h4 id="使用scp拷贝文件到手机的某个目录">使用scp拷贝文件到手机的某个目录</h4>
<ul>
<li>通过WiFi的方式</li>
</ul>
<pre><code>scp 本地文件路径 roo@192.168.1.2:手机的目录
</code></pre>
<ul>
<li>通过端口转发的方式</li>
</ul>
<pre><code>scp -P 2222 本地文件路径 root@localhost:手机的目录
</code></pre>
<p><em><strong>注意：</strong></em></p>
<blockquote>
<p>执行脚本的方式有三种<br>
分别为<code>sh xx.sh</code> <code>base xx.sh</code> <code>source xx.sh</code><br>
这里的 <code>sh xx.sh</code> <code>base xx.sh</code> 都是系统会开一个子进程去执行命令，执行完之后还是会返回到父进程的执行环境中。</p>
</blockquote>

      </div>
      <a href="https://dargonlee.github.io/post/ssh-lian-jie-shou-ji-de-fang-shi/" class="btn">
        Read more
      </a>
    </div>
    
  </div>

  <div class="p-8 border-b border-gray-200 dark:border-gray-700 flex relative overflow-hidden flex-col md:flex-row animated fadeIn">
    
    <div class="flex-1 order-2 md:order-1">
      <h2 class="text-2xl font-semibold mb-4">
        <a href="https://dargonlee.github.io/post/cycript-yu-fa-de-shi-yong/" class="text-gray-700 dark:text-gray-200 border-b-2 border-dotted border-gray-200 dark:border-gray-400 dark:hover:border-gray-200 hover:border-gray-600 transition-all duration-100">
          Cycript语法的使用
        </a>
      </h2>
      <div class="mb-4 text-xs text-gray-500">2020-07-25</div>
      <div class="mb-4 text-gray-500 dark:text-gray-300">
        <blockquote>
<p>可以用来探索、修改、调试正在运行的Mac/iOS 的APP。</p>
</blockquote>
<ul>
<li>在手机上安装 Cycript 插件</li>
<li>使用的使用需要先用Mac终端连接手机</li>
<li>终端输入 <code>cycript</code> 就进入了调试环境了</li>
<li>cycript -p [进程ID] 或者[com.SpringBoard]或者[可执行文件的名称]</li>
<li>可以用<code>ps</code>指令获取某个应用程序的进程id</li>
<li>退出 control + d</li>
</ul>

      </div>
      <a href="https://dargonlee.github.io/post/cycript-yu-fa-de-shi-yong/" class="btn">
        Read more
      </a>
    </div>
    
  </div>

  <div class="p-8 border-b border-gray-200 dark:border-gray-700 flex relative overflow-hidden flex-col md:flex-row animated fadeIn">
    
    <div class="flex-1 order-2 md:order-1">
      <h2 class="text-2xl font-semibold mb-4">
        <a href="https://dargonlee.github.io/post/ios-tuo-ke/" class="text-gray-700 dark:text-gray-200 border-b-2 border-dotted border-gray-200 dark:border-gray-400 dark:hover:border-gray-200 hover:border-gray-600 transition-all duration-100">
          iOS脱壳
        </a>
      </h2>
      <div class="mb-4 text-xs text-gray-500">2020-07-25</div>
      <div class="mb-4 text-gray-500 dark:text-gray-300">
        <h4 id="加壳">加壳</h4>
<blockquote>
<p>利用特殊的算法，对可执行文件的编码方式进行改变（比如压缩、加密），以达到保护程序代码的作用</p>
</blockquote>
<ul>
<li>
<p>加壳前：<br>
就是简单的可执行文件，执行之后把可执行文件装载在内存中</p>
</li>
<li>
<p>加壳后：<br>
可执行文件已经被加密了，不能直接用了。需要先加载到内存中，需要解密之后才能用。</p>
</li>
</ul>
<h4 id="脱壳">脱壳</h4>
<blockquote>
<p>摘掉壳程序，将未加密可执行文件还原出来</p>
</blockquote>
<ul>
<li>硬脱壳（iOS常用）</li>
</ul>
<blockquote>
<p>直接进行一个解密操作，不需要运行APP</p>
</blockquote>
<ul>
<li>动态脱壳</li>
</ul>
<blockquote>
<p>执行要脱壳的APP，将已经解密后的程序，从内存中直接拷贝出来。</p>
</blockquote>
<h5 id="ios中脱壳工具">iOS中脱壳工具</h5>
<ul>
<li>Cluth：https://github.com/KJCracks/Cluth</li>
<li>dumpdecrypted: https://github.com/stefanesser/dumpdecrypted</li>
</ul>
<h5 id="判断可执行文件是否加密">判断可执行文件是否加密</h5>
<pre><code>otool -l 文件路径 | grep crpyt 
</code></pre>
<p>如果cryptid 为1 是加密的 0是没有加密的</p>
<h4 id="cluth脱壳">Cluth脱壳</h4>
<blockquote>
<p>下载最新版本：https://github.com/KJCracks/Cluth</p>
</blockquote>
<p>把下载好的文件直接拷贝到手机的这个路径下<code>usr/bin</code></p>
<p>然后在连接手机端的命令窗口上输入：<code>Cluth脱壳</code>就行了，如果报错没有权限的话可以执行下面命令给这个执行文件授权</p>
<pre><code>chmod +x /usr/bin/Cluth
</code></pre>
<ul>
<li>列出手机上安装的应用：<code>Cluth -i</code>（只列出被加密的应用程序）</li>
<li>脱壳：<code>Cluth -d 应用的bundleId</code>（会输出一个脱壳后的ipa文件路径，把ipa文件拷贝到电脑上就行了）</li>
</ul>

      </div>
      <a href="https://dargonlee.github.io/post/ios-tuo-ke/" class="btn">
        Read more
      </a>
    </div>
    
  </div>

  <div class="p-8 border-b border-gray-200 dark:border-gray-700 flex relative overflow-hidden flex-col md:flex-row animated fadeIn">
    
    <div class="flex-1 order-2 md:order-1">
      <h2 class="text-2xl font-semibold mb-4">
        <a href="https://dargonlee.github.io/post/ni-xiang-chang-yong-gong-ju/" class="text-gray-700 dark:text-gray-200 border-b-2 border-dotted border-gray-200 dark:border-gray-400 dark:hover:border-gray-200 hover:border-gray-600 transition-all duration-100">
          逆向常用工具
        </a>
      </h2>
      <div class="mb-4 text-xs text-gray-500">2020-07-25</div>
      <div class="mb-4 text-gray-500 dark:text-gray-300">
        <h4 id="逆向app思路">逆向APP思路</h4>
<ul>
<li>
<p>界面分析（Cycript、Reveal）</p>
</li>
<li>
<p>代码分析（对Mach-o文件分析）<br>
MachOView、class-dump、Hopper Disassembler、ida等</p>
</li>
<li>
<p>动态调试<br>
对运行的App进行代码调试（debugserver、LLDB）</p>
</li>
<li>
<p>代码编写<br>
注入代码到App中，必要时可能会重签名ipa</p>
</li>
</ul>
<h4 id="class-dump的安装">class-dump的安装</h4>
<ul>
<li>先去下载 <code>class-dump</code>的可执行文件</li>
<li>然后把它复制到系统的<code>/usr/local/bin</code>目录下</li>
<li>执行<code>class-dump -H mach-o文件路径 -o 头文件存放路径</code></li>
</ul>
<h4 id="抽取系统框架的可执行文件">抽取系统框架的可执行文件</h4>
<ul>
<li>找到系统的动态库缓存文件 <code>Device/System/Libary/Caches/com.apple.dyld</code></li>
<li>里面会有两个文件一个<code>dyld_shared_cache_arm64</code>的、一个是<code>dyld_shared_cache_armv7s</code> 这里面装的分别是不同架构的系统框架可执行文件</li>
<li>但是文件太大，我们需要通过一个解析器去给解析处理各个framework的可执行文件</li>
<li>去找到<code>dyld</code>的源码<code>https://opensource.apple.com/tarballs/dyld/</code> 找到最新版本的下载下来</li>
<li>找到工程中<code>launch-cache/dsc_extractor.app</code>文件用<code>clang++</code>编译器编译成可执行文件（只要int main函数里面的东西，此函数上面的内容都可以不要）</li>
<li><code>clang++ -o dsc_extractor dsc_extractor.app</code> 会生成<code>dsc_extractor</code>可执行文件</li>
<li><code>./dsc_extractor dyld_shared_cache_armv7s armv7s</code> 回车执行 就会抽取包含在系统共享文件中的系统库可执行文件</li>
</ul>
<h4 id="mach-o的结构">Mach-o的结构</h4>
<ul>
<li><code>file</code>:查看Mach-o文件的结构</li>
</ul>
<pre><code>file 文件的路径
</code></pre>
<ul>
<li><code>otool</code>:查看Mach-o特定部分和段的内容</li>
</ul>
<pre><code>打印Mach-o文件里面链接了哪些库：otool -L 文件地址
打印Mach-o文件头信息：otool -f 文件地址
</code></pre>
<ul>
<li><code>lipo</code>:常用于多架构Mach-o文件的处理</li>
</ul>
<pre><code>查看架构信息：lipo -info 文件路径
导出特定架构：lipo 文件路径 -thin 架构类型 -output 输出文件路径
合并多种架构：lipo 文件路径1 文件路径2 -output 输出文件路径 
</code></pre>
<h4 id="配置reveal环境">配置Reveal环境</h4>
<ul>
<li>先安装<code>Reveal Loader</code> 插件</li>
<li>然后把Reveal的framework里的RevealServer替换到手里<code>Libary/RHReveal/目录下</code></li>
<li>killall SpringBoard 重启</li>
</ul>
<h4 id="theos-安装">theos 安装</h4>
<ul>
<li>安装签名工具<code>brew install ldid</code></li>
<li>修改环境变量</li>
</ul>
<pre><code>vim ~/.zshrc 或者 vim ~/.bash_profile
export THEOS=~/theos
export PATH=$THEOS/bin:$PATH
</code></pre>
<p>执行<code>source .zshrc</code>这样环境变量才会生效或者重启终端</p>
<ul>
<li>下载theos</li>
</ul>
<pre><code>git clone --recursive https://github.com/theos/theos.git $THEOS // --recursive递归下载
</code></pre>
<ul>
<li>新建项目</li>
</ul>
<pre><code>nic.pl
</code></pre>

      </div>
      <a href="https://dargonlee.github.io/post/ni-xiang-chang-yong-gong-ju/" class="btn">
        Read more
      </a>
    </div>
    
  </div>

  <div class="p-8 border-b border-gray-200 dark:border-gray-700 flex relative overflow-hidden flex-col md:flex-row animated fadeIn">
    
    <div class="flex-1 order-2 md:order-1">
      <h2 class="text-2xl font-semibold mb-4">
        <a href="https://dargonlee.github.io/post/tweak-kai-fa-shou-ce/" class="text-gray-700 dark:text-gray-200 border-b-2 border-dotted border-gray-200 dark:border-gray-400 dark:hover:border-gray-200 hover:border-gray-600 transition-all duration-100">
          Tweak开发手册
        </a>
      </h2>
      <div class="mb-4 text-xs text-gray-500">2020-07-25</div>
      <div class="mb-4 text-gray-500 dark:text-gray-300">
        <h4 id="tweak怎么多文件开发">tweak怎么多文件开发</h4>
<blockquote>
<p>一般来说我们开发tweak代码都是在<code>Tweak.xm</code>文件里面写代码，但是代码量小的话还好，一旦代码多了的话，代码开发起来就比较费劲。这个时候我们就可以使用多文件进行开发。</p>
</blockquote>
<ul>
<li>可以在<code>Tweak.xm</code>所在的目录下新建一个<code>src</code>文件夹，里面放你写的OC源代码。</li>
<li>然后在<code>Tweak.xm</code>文件是使用的地方<code>#import &quot;Person&quot;</code>导入就可以用了</li>
<li>但是在编译的时候你会发现报错，因为你写的<code>.m</code>文件没有参与编译</li>
<li>所以我们需要在<code>Makefile</code>里面的tweak_wechat_FILES = Tweak.xm指定下要参与编译的<code>.m</code>文件</li>
</ul>
<pre><code>tweak_wechat_FILES = Tweak.xm src/Persom.m // 记住多个文件以空格分割
</code></pre>

      </div>
      <a href="https://dargonlee.github.io/post/tweak-kai-fa-shou-ce/" class="btn">
        Read more
      </a>
    </div>
    
  </div>

  <div class="p-8 border-b border-gray-200 dark:border-gray-700 flex relative overflow-hidden flex-col md:flex-row animated fadeIn">
    
    <div class="flex-1 order-2 md:order-1">
      <h2 class="text-2xl font-semibold mb-4">
        <a href="https://dargonlee.github.io/post/ios-dong-tai-diao-shi/" class="text-gray-700 dark:text-gray-200 border-b-2 border-dotted border-gray-200 dark:border-gray-400 dark:hover:border-gray-200 hover:border-gray-600 transition-all duration-100">
          iOS 动态调试
        </a>
      </h2>
      <div class="mb-4 text-xs text-gray-500">2020-07-25</div>
      <div class="mb-4 text-gray-500 dark:text-gray-300">
        <h4 id="什么是动态调试">什么是动态调试？</h4>
<blockquote>
<p>将程序运行起来，通过下断电、打印等方式。查看参数、返回值、函数调用流程等。</p>
</blockquote>
<h4 id="xcode的动态调试原理">Xcode的动态调试原理</h4>
<ul>
<li>
<p>关于 <code>GCC</code> <code>LLVM</code> <code>GDB</code> <code>LLDB</code></p>
<ul>
<li>Xcode 的编译器发展历程：GCC -&gt; LLVM</li>
<li>Xcode 的调试器发展历程：GDB -&gt; LLDB</li>
</ul>
</li>
<li>
<p>debugserver一开始存放在Mac上的Xcode里面</p>
</li>
<li>
<p>当Xcode识别手机设备的时候，Xcode会自动将debugserver安装到手机上</p>
</li>
<li>
<p>Xcode的调试局限性：一般只能安装通过Xcode安装的APP</p>
</li>
</ul>
<h4 id="动态调试任意app">动态调试任意APP</h4>
<h6 id="debugserver的权限问题">debugserver的权限问题</h6>
<ul>
<li>
<p>默认情况下<code>/Developer/usr/bin/debugserver</code>缺少一定的权限，只能调试通过Xcode安装的APP，无法调试其他APP 比如App Store上的APP</p>
</li>
<li>
<p>如果希望调试其他APP，需要对debugserver进行重新签名，签上2个调试相关的权限</p>
</li>
</ul>
<p><code>get-task-allow</code> 和 <code>task_for_pid-allow</code></p>
<h6 id="如何给debugserver签上权限">如何给debugserver签上权限</h6>
<ul>
<li>iPhone上的<code>/Developer</code>的目录是只读的，无法直接对<code>/Developer/usr/bin/debugserver</code>文件签名，需要先把debugserver文件复制到Mac上</li>
<li>通过ldid命令导出debugserver文件现在的权限</li>
</ul>
<pre><code>ldid -e debugserver &gt; debugserver.entitlements // 会生成一个debugserver.entitlements文件
</code></pre>
<ul>
<li>在<code>debugserver.entitlements</code>文件开始编辑点击加号 添加 <code>get-task-allow</code> 和 <code>task_for_pid-allow</code> 并设置值为YES</li>
<li>编辑好后保存再重新签名</li>
</ul>
<pre><code>ldid -Sdebugserver.entitlements debugserver // 然后debugserver的权限就加上去了
</code></pre>
<ul>
<li><strong>注意</strong>由于iPhone上的<code>/Developer</code>的目录是只读的，所以你签好文件不能直接赋值到手机上</li>
<li>可以直接把它放到<code>usr/bin</code>目录下，可以直接使用</li>
</ul>
<pre><code>chmod +x /usr/bin/debugserver //给执行权限
</code></pre>
<ul>
<li>然后在手机终端就可以直接使用了</li>
</ul>
<h6 id="让debugserver附加到某个app进程中">让debugserver附加到某个APP进程中</h6>
<p>先使用ssh登录到手机root用户然后执行下面命令</p>
<pre><code>debugserver *:端口号 -a 进程
debugserver *:10011 -a WeChat
</code></pre>
<ul>
<li><code>*:端口号</code>：使用iPhone的某个端口启动debugserver服务（只要不是保留端口就行）</li>
<li><code>-a</code>:进程输入APP的进程信息（进程ID或者进程名称）</li>
</ul>
<h6 id="在mac上启动lldb远程连接iphone上的debugserver服务">在Mac上启动LLDB，远程连接iPhone上的debugserver服务</h6>
<ul>
<li>启动LLDB</li>
</ul>
<pre><code>lldb
</code></pre>
<ul>
<li>连接debugserver服务</li>
</ul>
<pre><code>(lldb) process connect connect://手机IP地址:debugserver服务的端口号
(lldb) process connect connect://10.1.125.100:10011
</code></pre>
<ul>
<li>如果是通过端口转发的方式连接手机的话通过下面方式连接<br>
转发端口</li>
</ul>
<pre><code>iproxy 22:2222 10011:9999 // 这样就转发了手机上的两个端口
</code></pre>
<p>然后登录到手机</p>
<pre><code>ssh -p 2222 root@localhost
</code></pre>
<p>转发debugserver端口</p>
<pre><code>debugserver *:10011 -a WeChat
</code></pre>
<p>之后再使用lldb连接debugserver服务器</p>
<pre><code>(lldb) process connect connect://localhost:10011
</code></pre>
<ul>
<li>使用LLDB的<code>c</code>命令让程序先继续运行</li>
</ul>
<pre><code>(lldb)  c
</code></pre>
<p>然后就监听成功了。</p>
<h6 id="通过debugserver启动app">通过debugserver启动APP</h6>
<pre><code>debugserver -x auto*:端口号 APP可执行文件路径
</code></pre>

      </div>
      <a href="https://dargonlee.github.io/post/ios-dong-tai-diao-shi/" class="btn">
        Read more
      </a>
    </div>
    
  </div>

  <div class="p-8 border-b border-gray-200 dark:border-gray-700 flex relative overflow-hidden flex-col md:flex-row animated fadeIn">
    
    <div class="flex-1 order-2 md:order-1">
      <h2 class="text-2xl font-semibold mb-4">
        <a href="https://dargonlee.github.io/post/chang-yong-lldb-zhi-ling/" class="text-gray-700 dark:text-gray-200 border-b-2 border-dotted border-gray-200 dark:border-gray-400 dark:hover:border-gray-200 hover:border-gray-600 transition-all duration-100">
          常用LLDB指令
        </a>
      </h2>
      <div class="mb-4 text-xs text-gray-500">2020-07-25</div>
      <div class="mb-4 text-gray-500 dark:text-gray-300">
        <h5 id="指令格式">指令格式</h5>
<pre><code>&lt;command&gt; [&lt;subcommand&gt; [&lt;subcommand&gt;]...] &lt;actions&gt; [-options [options value]] [argument[argument]...]
</code></pre>
<ul>
<li><command> 命令</li>
<li><subcommand>子命令</li>
<li><actions>命令操作</li>
<li><options>命令选项</li>
<li><argument> 命令参数</li>
</ul>
<p>比如给<code>test</code>函数设置断点</p>

      </div>
      <a href="https://dargonlee.github.io/post/chang-yong-lldb-zhi-ling/" class="btn">
        Read more
      </a>
    </div>
    
  </div>
  
      </div>

      
      <footer class="py-12 text-center px-4 md:px-0" v-pre>
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Harlans</a>
</footer>

    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://dargonlee.github.io/media/scripts/main.js"></script>
</body>
</html>